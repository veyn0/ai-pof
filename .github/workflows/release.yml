name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Determine Minecraft version
        id: mc
        run: |
          python - <<'PY'
          import os
          import re
          import xml.etree.ElementTree as ET

          tree = ET.parse("pom.xml")
          root = tree.getroot()
          ns = {"m": "http://maven.apache.org/POM/4.0.0"}

          version_text = None
          for dep in root.findall(".//m:dependency", ns):
              artifact = dep.find("m:artifactId", ns)
              if artifact is not None and artifact.text == "paper-api":
                  ver = dep.find("m:version", ns)
                  if ver is not None and ver.text:
                      version_text = ver.text.strip()
                      break

          if not version_text:
              raise SystemExit("paper-api version not found in pom.xml")

          match = re.match(r"(\\d+\\.\\d+(?:\\.\\d+)?)", version_text)
          if not match:
              raise SystemExit(f"Could not parse Minecraft version from {version_text}")

          mc_version = match.group(1)
          output_path = os.environ.get("GITHUB_OUTPUT")
          if not output_path:
              raise SystemExit("GITHUB_OUTPUT is not set")
          with open(output_path, "a", encoding="utf-8") as fh:
              fh.write(f"mc_version={mc_version}\\n")
          PY

      - name: Build with Maven
        run: mvn -B -DskipTests package

      - name: Prepare release asset
        id: asset
        run: |
          RELEASE_ID="${{ steps.mc.outputs.mc_version }}-${{ github.run_number }}"
          JAR_PATH=$(ls target/ai-pof-*.jar | grep -v 'original-' | head -n 1)
          if [ -z "$JAR_PATH" ]; then
            echo "No jar artifact found in target/." >&2
            exit 1
          fi
          OUT_JAR="ai-pof-${RELEASE_ID}.jar"
          cp "$JAR_PATH" "$OUT_JAR"
          echo "release_id=$RELEASE_ID" >> "$GITHUB_OUTPUT"
          echo "asset=$OUT_JAR" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.asset.outputs.release_id }}"
          name: "v${{ steps.asset.outputs.release_id }}"
          files: "${{ steps.asset.outputs.asset }}"
